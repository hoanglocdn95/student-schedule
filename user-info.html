<!-- user-info.html: Nhập thông tin cá nhân -->
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="q3logo.png" />
    <title>Thông tin cá nhân</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 500px;
        margin: 20px auto;
      }
      label {
        font-weight: bold;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 8px;
        margin: 5px 0 15px;
      }
      button {
        padding: 10px 20px;
        cursor: pointer;
      }
      #examBookedContainer {
        display: none;
      }
    </style>
  </head>
  <body>
    <h2>Nhập thông tin cá nhân</h2>
    <form id="userInfoForm">
      <label for="name">Tên:</label>
      <input type="text" id="name" required />

      <label for="email">Email:</label>
      <input type="email" id="email" required readonly />

      <label for="timezone">Chọn múi giờ:</label>
      <select id="timezone">
        <option value="(GMT+7) Việt Nam">(GMT+7) Việt Nam</option>
        <option value="(GMT +10:30) Adelaide">(GMT +10:30) Adelaide</option>
      </select>

      <label for="pteExamDate">Ngày định thi PTE:</label>
      <input type="date" id="pteExamDate" />

      <div id="examBookedContainer">
        <label>
          <input type="checkbox" id="examBooked" />
          Đã book lịch thi chưa?
        </label>
      </div>

      <label for="notes">Ghi chú cho Q3 Language:</label>
      <textarea id="notes" rows="3"></textarea>

      <label for="minHoursPerWeek">Số giờ học tối thiểu / tuần:</label>
      <input type="number" id="minHoursPerWeek" min="1" max="10" required />

      <label for="maxHoursPerWeek">Số giờ học tối đa / tuần:</label>
      <input type="number" id="maxHoursPerWeek" min="1" max="12" required />

      <label for="minHoursPerSession">Số giờ học tối thiểu / buổi:</label>
      <input
        type="number"
        id="minHoursPerSession"
        min="1"
        max="1.5"
        step="0.5"
        required
      />

      <label for="maxHoursPerSession">Số giờ học tối đa / buổi:</label>
      <input
        type="number"
        id="maxHoursPerSession"
        min="1"
        max="1.5"
        step="0.5"
        required
      />

      <button type="submit">Lưu thông tin</button>
    </form>

    <script>
      const GOOGLE_API_URL =
        "https://script.google.com/macros/s/AKfycbxlNrImcEVkcURfSIpI1zpi6aI4WDI-qachQ4uMlvDHBt6pjNxPfZr5V1LjbH_RsmttdQ/exec";

      document.addEventListener("DOMContentLoaded", async function () {
        const emailField = document.getElementById("email");
        const storedEmail = sessionStorage.getItem("user_email");
        if (storedEmail) {
          emailField.value = storedEmail;
          await fetchUserData(storedEmail);
        }

        document
          .getElementById("pteExamDate")
          .addEventListener("change", function () {
            document.getElementById("examBookedContainer").style.display = this
              .value
              ? "block"
              : "none";
          });

        document
          .getElementById("userInfoForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();

            const userData = {
              type: "user_info", // Xác định loại dữ liệu
              name: document.getElementById("name").value,
              email: document.getElementById("email").value,
              timezone: document.getElementById("timezone").value,
              pteExamDate: document.getElementById("pteExamDate").value,
              examBooked: document.getElementById("examBooked").checked
                ? "Yes"
                : "No",
              notes: document.getElementById("notes").value,
              minHoursPerWeek: document.getElementById("minHoursPerWeek").value,
              maxHoursPerWeek: document.getElementById("maxHoursPerWeek").value,
              minHoursPerSession:
                document.getElementById("minHoursPerSession").value,
              maxHoursPerSession:
                document.getElementById("maxHoursPerSession").value,
            };

            fetch(GOOGLE_API_URL, {
              redirect: "follow",
              method: "POST",
              headers: { "Content-Type": "text/plain;charset=utf-8" },
              body: JSON.stringify(userData),
            })
              .then((response) => {
                console.log(" .then ~ data:", response.json());
                window.location.href = "calendar-register.html";
                return response.json();
              })
              .catch((error) => {
                console.log(" error:", error);
              });
          });
      });

      async function fetchUserData(email) {
        try {
          const response = await fetch(
            `${GOOGLE_API_URL}?type=get_user&email=${email}`,
            {
              redirect: "follow",
              method: "GET",
              headers: { "Content-Type": "text/plain;charset=utf-8" },
            }
          );
          const data = await response.json();
          console.log(" fetchUserData ~ data:", data);

          if (data.success && data.user) {
            document.getElementById("name").value = data.user.name || "";
            document.getElementById("timezone").value =
              data.user.timezone || "";

            if (data.user.pteExamDate) {
              const dateObj = new Date(data.user.pteExamDate);
              const formattedDate = dateObj.toISOString().split("T")[0]; // Lấy phần YYYY-MM-DD
              document.getElementById("pteExamDate").value = formattedDate;
            }
            document.getElementById("examBooked").checked =
              data.user.examBooked === "Yes";
            document.getElementById("notes").value = data.user.notes || "";
            document.getElementById("minHoursPerWeek").value =
              data.user.minHoursPerWeek || "";
            document.getElementById("maxHoursPerWeek").value =
              data.user.maxHoursPerWeek || "";
            document.getElementById("minHoursPerSession").value =
              data.user.minHoursPerSession || "";
            document.getElementById("maxHoursPerSession").value =
              data.user.maxHoursPerSession || "";

            document.getElementById("examBookedContainer").style.display = data
              .user.pteExamDate
              ? "block"
              : "none";
          }
        } catch (error) {
          console.error("Lỗi khi lấy dữ liệu:", error);
        }
      }
    </script>
  </body>
</html>
